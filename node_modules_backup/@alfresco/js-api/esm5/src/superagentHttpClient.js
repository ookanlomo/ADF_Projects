/*!
 * @license
 * Copyright Â© 2005-2023 Hyland Software, Inc. and its affiliates. All rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { __assign } from "tslib";
import superagent from 'superagent';
import { isBrowser, paramToString } from './utils';
var isProgressEvent = function (event) { return event === null || event === void 0 ? void 0 : event.lengthComputable; };
var SuperagentHttpClient = (function () {
    function SuperagentHttpClient() {
        this.timeout = undefined;
    }
    SuperagentHttpClient.prototype.post = function (url, options, securityOptions, emitters) {
        return this.request(url, __assign(__assign({}, options), { httpMethod: 'POST' }), securityOptions, emitters);
    };
    SuperagentHttpClient.prototype.put = function (url, options, securityOptions, emitters) {
        return this.request(url, __assign(__assign({}, options), { httpMethod: 'PUT' }), securityOptions, emitters);
    };
    SuperagentHttpClient.prototype.get = function (url, options, securityOptions, emitters) {
        return this.request(url, __assign(__assign({}, options), { httpMethod: 'GET' }), securityOptions, emitters);
    };
    SuperagentHttpClient.prototype.delete = function (url, options, securityOptions, emitters) {
        return this.request(url, __assign(__assign({}, options), { httpMethod: 'DELETE' }), securityOptions, emitters);
    };
    SuperagentHttpClient.prototype.request = function (url, options, securityOptions, emitters) {
        var httpMethod = options.httpMethod, queryParams = options.queryParams, headerParams = options.headerParams, formParams = options.formParams, bodyParam = options.bodyParam, contentType = options.contentType, accept = options.accept, responseType = options.responseType, returnType = options.returnType;
        var eventEmitter = emitters.eventEmitter, apiClientEmitter = emitters.apiClientEmitter;
        var request = this.buildRequest(httpMethod, url, queryParams, headerParams, formParams, bodyParam, contentType, accept, responseType, eventEmitter, returnType, securityOptions);
        if (returnType === 'Binary') {
            request = request.buffer(true).parse(superagent.parse['application/octet-stream']);
        }
        var promise = new Promise(function (resolve, reject) {
            request.on('abort', function () {
                eventEmitter.emit('abort');
            });
            request.end(function (error, response) {
                if (error) {
                    apiClientEmitter.emit('error', error);
                    eventEmitter.emit('error', error);
                    if (error.status === 401) {
                        apiClientEmitter.emit('unauthorized');
                        eventEmitter.emit('unauthorized');
                    }
                    if (response && response.text) {
                        error = error || {};
                        reject(Object.assign(error, { message: response.text }));
                    }
                    else {
                        reject({ error: error });
                    }
                }
                else {
                    if (securityOptions.isBpmRequest) {
                        if (response.header && response.header.hasOwnProperty('set-cookie')) {
                            securityOptions.authentications.cookie = response.header['set-cookie'][0];
                        }
                    }
                    var data = {};
                    if (response.type === 'text/html') {
                        data = SuperagentHttpClient.deserialize(response);
                    }
                    else {
                        data = SuperagentHttpClient.deserialize(response, returnType);
                    }
                    eventEmitter.emit('success', data);
                    resolve(data);
                }
            });
        });
        promise.abort = function () {
            request.abort();
            return this;
        };
        return promise;
    };
    SuperagentHttpClient.prototype.buildRequest = function (httpMethod, url, queryParams, headerParams, formParams, bodyParam, contentType, accept, responseType, eventEmitter, returnType, securityOptions) {
        var _this = this;
        var request = superagent(httpMethod, url);
        var isBpmRequest = securityOptions.isBpmRequest, authentications = securityOptions.authentications, _a = securityOptions.defaultHeaders, defaultHeaders = _a === void 0 ? {} : _a, enableCsrf = securityOptions.enableCsrf, _b = securityOptions.withCredentials, withCredentials = _b === void 0 ? false : _b;
        this.applyAuthToRequest(request, authentications);
        request.query(SuperagentHttpClient.normalizeParams(queryParams));
        request.set(defaultHeaders).set(SuperagentHttpClient.normalizeParams(headerParams));
        if (isBpmRequest && enableCsrf) {
            this.setCsrfToken(request);
        }
        if (withCredentials) {
            request.withCredentials();
        }
        if (isBpmRequest) {
            request.withCredentials();
            if (securityOptions.authentications.cookie) {
                if (!isBrowser()) {
                    request.set('Cookie', securityOptions.authentications.cookie);
                }
            }
        }
        request.timeout(this.timeout);
        if (contentType && contentType !== 'multipart/form-data') {
            request.type(contentType);
        }
        else if (!request.header['Content-Type'] && contentType !== 'multipart/form-data') {
            request.type('application/json');
        }
        if (contentType === 'application/x-www-form-urlencoded') {
            request.send(SuperagentHttpClient.normalizeParams(formParams)).on('progress', function (event) {
                _this.progress(event, eventEmitter);
            });
        }
        else if (contentType === 'multipart/form-data') {
            var _formParams = SuperagentHttpClient.normalizeParams(formParams);
            for (var key in _formParams) {
                if (_formParams.hasOwnProperty(key)) {
                    if (SuperagentHttpClient.isFileParam(_formParams[key])) {
                        request.attach(key, _formParams[key]).on('progress', function (event) {
                            _this.progress(event, eventEmitter);
                        });
                    }
                    else {
                        request.field(key, _formParams[key]).on('progress', function (event) {
                            _this.progress(event, eventEmitter);
                        });
                    }
                }
            }
        }
        else if (bodyParam) {
            request.send(bodyParam).on('progress', function (event) {
                _this.progress(event, eventEmitter);
            });
        }
        if (accept) {
            request.accept(accept);
        }
        if (returnType === 'blob' || returnType === 'Blob' || responseType === 'blob' || responseType === 'Blob') {
            request.responseType('blob');
        }
        else if (returnType === 'String') {
            request.responseType('string');
        }
        return request;
    };
    SuperagentHttpClient.prototype.setCsrfToken = function (request) {
        var token = SuperagentHttpClient.createCSRFToken();
        request.set('X-CSRF-TOKEN', token);
        if (!isBrowser()) {
            request.set('Cookie', 'CSRF-TOKEN=' + token + ';path=/');
        }
        try {
            document.cookie = 'CSRF-TOKEN=' + token + ';path=/';
        }
        catch (err) {
        }
    };
    SuperagentHttpClient.prototype.applyAuthToRequest = function (request, authentications) {
        if (authentications) {
            switch (authentications.type) {
                case 'basic': {
                    var basicAuth = authentications.basicAuth;
                    if (basicAuth.username || basicAuth.password) {
                        request.auth(basicAuth.username ? encodeURI(basicAuth.username) : '', basicAuth.password ? encodeURI(basicAuth.password) : '');
                    }
                    break;
                }
                case 'activiti': {
                    if (authentications.basicAuth.ticket) {
                        request.set({ Authorization: authentications.basicAuth.ticket });
                    }
                    break;
                }
                case 'oauth2': {
                    var oauth2 = authentications.oauth2;
                    if (oauth2.accessToken) {
                        request.set({ Authorization: 'Bearer ' + oauth2.accessToken });
                    }
                    break;
                }
                default:
                    throw new Error('Unknown authentication type: ' + authentications.type);
            }
        }
    };
    SuperagentHttpClient.prototype.progress = function (event, eventEmitter) {
        if (isProgressEvent(event)) {
            var percent = Math.round((event.loaded / event.total) * 100);
            var progress = {
                total: event.total,
                loaded: event.loaded,
                percent: percent,
            };
            eventEmitter.emit('progress', progress);
        }
    };
    SuperagentHttpClient.createCSRFToken = function (a) {
        return a ? (a ^ ((Math.random() * 16) >> (a / 4))).toString(16) : ([1e16] + (1e16).toString()).replace(/[01]/g, SuperagentHttpClient.createCSRFToken);
    };
    SuperagentHttpClient.deserialize = function (response, returnType) {
        if (response === null) {
            return null;
        }
        var data = response.body;
        if (data === null) {
            data = response.text;
        }
        if (returnType) {
            if (returnType === 'blob' && isBrowser()) {
                data = new Blob([data], { type: response.header['content-type'] });
            }
            else if (returnType === 'blob' && !isBrowser()) {
                data = new Buffer.from(data, 'binary');
            }
            else if (Array.isArray(data)) {
                data = data.map(function (element) {
                    return new returnType(element);
                });
            }
            else {
                data = new returnType(data);
            }
        }
        return data;
    };
    SuperagentHttpClient.normalizeParams = function (params) {
        var newParams = {};
        for (var key in params) {
            if (params.hasOwnProperty(key) && params[key] !== undefined && params[key] !== null) {
                var value = params[key];
                if (SuperagentHttpClient.isFileParam(value) || Array.isArray(value)) {
                    newParams[key] = value;
                }
                else {
                    newParams[key] = paramToString(value);
                }
            }
        }
        return newParams;
    };
    SuperagentHttpClient.isFileParam = function (param) {
        if (typeof Buffer === 'function' && (param instanceof Buffer || param.path)) {
            return true;
        }
        if (typeof Blob === 'function' && param instanceof Blob) {
            return true;
        }
        if (typeof File === 'function' && param instanceof File) {
            return true;
        }
        if (typeof File === 'object' && param instanceof File) {
            return true;
        }
        return false;
    };
    return SuperagentHttpClient;
}());
export { SuperagentHttpClient };
//# sourceMappingURL=../../../src/superagentHttpClient.js.map