/*!
 * @license
 * Copyright Â© 2005-2023 Hyland Software, Inc. and its affiliates. All rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { __assign } from "tslib";
import ee from 'event-emitter';
import { SuperagentHttpClient } from './superagentHttpClient';
import { paramToString } from './utils';
export function buildCollectionParam(param, collectionFormat) {
    if (!param) {
        return null;
    }
    switch (collectionFormat) {
        case 'csv':
            return param.map(paramToString).join(',');
        case 'ssv':
            return param.map(paramToString).join(' ');
        case 'tsv':
            return param.map(paramToString).join('\t');
        case 'pipes':
            return param.map(paramToString).join('|');
        case 'multi':
            return param.map(paramToString);
        default:
            throw new Error('Unknown collection format: ' + collectionFormat);
    }
}
var AlfrescoApiClient = (function () {
    function AlfrescoApiClient(host, httpClient) {
        this.basePath = '';
        this.authentications = {
            basicAuth: {
                ticket: '',
            },
            type: 'basic',
        };
        this.defaultHeaders = {};
        this.timeout = undefined;
        this.contentTypes = {
            JSON: ['application/json'],
        };
        this.host = host;
        this.httpClient = httpClient || new SuperagentHttpClient();
        ee(this);
    }
    AlfrescoApiClient.prototype.request = function (options) {
        return this.buildRequestCall(this.basePath, options, this.httpClient.request.bind(this.httpClient));
    };
    AlfrescoApiClient.prototype.post = function (options) {
        var url = this.getCallApiUrl(options);
        return this.buildRequestCall(url, options, this.httpClient.post.bind(this.httpClient));
    };
    AlfrescoApiClient.prototype.put = function (options) {
        var url = this.getCallApiUrl(options);
        return this.buildRequestCall(url, options, this.httpClient.put.bind(this.httpClient));
    };
    AlfrescoApiClient.prototype.get = function (options) {
        var url = this.getCallApiUrl(options);
        return this.buildRequestCall(url, options, this.httpClient.get.bind(this.httpClient));
    };
    AlfrescoApiClient.prototype.delete = function (options) {
        return this.buildRequestCall(this.basePath, options, this.httpClient.delete.bind(this.httpClient));
    };
    AlfrescoApiClient.prototype.callApi = function (path, httpMethod, pathParams, queryParams, headerParams, formParams, bodyParam, contentTypes, accepts, returnType, contextRoot, responseType, url) {
        var callApiUrl = url !== null && url !== void 0 ? url : this.getCallApiUrl({ contextRoot: contextRoot, path: path, pathParams: pathParams });
        var options = {
            path: path,
            httpMethod: httpMethod,
            pathParams: pathParams,
            queryParams: queryParams,
            headerParams: headerParams,
            formParams: formParams,
            bodyParam: bodyParam,
            contentTypes: contentTypes,
            accepts: accepts,
            returnType: returnType,
            contextRoot: contextRoot,
            responseType: responseType,
            url: url,
        };
        return this.buildRequestCall(callApiUrl, options, this.httpClient.request.bind(this.httpClient));
    };
    AlfrescoApiClient.prototype.callCustomApi = function (path, httpMethod, pathParams, queryParams, headerParams, formParams, bodyParam, contentTypes, accepts, returnType, contextRoot, responseType) {
        var customApiUrl = AlfrescoApiClient.buildUrl(path, '', pathParams);
        var options = {
            path: path,
            httpMethod: httpMethod,
            pathParams: pathParams,
            queryParams: queryParams,
            headerParams: headerParams,
            formParams: formParams,
            bodyParam: bodyParam,
            contentTypes: contentTypes,
            accepts: accepts,
            returnType: returnType,
            contextRoot: contextRoot,
            responseType: responseType,
        };
        return this.buildRequestCall(customApiUrl, options, this.httpClient.request.bind(this.httpClient));
    };
    AlfrescoApiClient.prototype.isCsrfEnabled = function () {
        if (this.config) {
            return !this.config.disableCsrf;
        }
        else {
            return true;
        }
    };
    AlfrescoApiClient.prototype.isBpmRequest = function () {
        return this.className === 'ProcessAuth' || this.className === 'ProcessClient';
    };
    AlfrescoApiClient.prototype.basicAuth = function (username, password) {
        var str = username + ':' + password;
        var base64;
        if (typeof Buffer === 'function') {
            base64 = Buffer.from(str.toString(), 'binary').toString('base64');
        }
        else {
            base64 = btoa(str);
        }
        return 'Basic ' + base64;
    };
    AlfrescoApiClient.prototype.isWithCredentials = function () {
        var _a;
        return !!((_a = this.config) === null || _a === void 0 ? void 0 : _a.withCredentials);
    };
    AlfrescoApiClient.prototype.getAlfTicket = function (ticket) {
        var ticketParam = this.isWithCredentials() ? '&ticket=' : '&alf_ticket=';
        if (ticket) {
            return ticketParam + ticket;
        }
        else if (this.config.ticketEcm) {
            return ticketParam + this.config.ticketEcm;
        }
        return '';
    };
    AlfrescoApiClient.buildUrl = function (basePath, path, pathParams) {
        if (path && path !== '' && !path.match(/^\//)) {
            path = '/' + path;
        }
        var url = basePath + path;
        return AlfrescoApiClient.addParamsToUrl(url, pathParams);
    };
    AlfrescoApiClient.addParamsToUrl = function (path, pathParams) {
        return path.replace(/\{([\w-]+)\}/g, function (fullMatch, key) {
            var value;
            if (pathParams.hasOwnProperty(key)) {
                value = paramToString(pathParams[key]);
            }
            else {
                value = fullMatch;
            }
            return encodeURIComponent(value);
        });
    };
    AlfrescoApiClient.prototype.getCallApiUrl = function (_a) {
        var contextRoot = _a.contextRoot, path = _a.path, pathParams = _a.pathParams;
        var basePath = contextRoot ? "".concat(this.host, "/").concat(contextRoot) : this.basePath;
        return AlfrescoApiClient.buildUrl(basePath, path, pathParams);
    };
    AlfrescoApiClient.prototype.buildRequestCall = function (url, options, httpCall) {
        var security = this.getSecurityOptions();
        var emitters = this.getEventEmitters();
        var httpRequestOptions = this.getRequestOptionsWithAcceptAndContentType(options);
        var promise = httpCall(url, httpRequestOptions, security, emitters);
        return this.addPromiseListeners(promise, emitters.eventEmitter);
    };
    AlfrescoApiClient.prototype.getSecurityOptions = function () {
        return {
            isBpmRequest: this.isBpmRequest(),
            enableCsrf: this.isCsrfEnabled(),
            withCredentials: this.isWithCredentials(),
            authentications: this.authentications,
            defaultHeaders: this.defaultHeaders,
        };
    };
    AlfrescoApiClient.prototype.getEventEmitters = function () {
        var apiClientEmitter = {
            on: this.on.bind(this),
            off: this.off.bind(this),
            once: this.once.bind(this),
            emit: this.emit.bind(this),
        };
        return {
            apiClientEmitter: apiClientEmitter,
            eventEmitter: ee({}),
        };
    };
    AlfrescoApiClient.prototype.getRequestOptionsWithAcceptAndContentType = function (options) {
        var contentType = AlfrescoApiClient.jsonPreferredMime(options.contentTypes);
        var accept = AlfrescoApiClient.jsonPreferredMime(options.accepts);
        return __assign(__assign({}, options), { contentType: contentType, accept: accept });
    };
    AlfrescoApiClient.jsonPreferredMime = function (contentTypes) {
        if (!contentTypes || !contentTypes.length) {
            return 'application/json';
        }
        for (var i = 0; i < contentTypes.length; i++) {
            if (AlfrescoApiClient.isJsonMime(contentTypes[i])) {
                return contentTypes[i];
            }
        }
        return contentTypes[0];
    };
    AlfrescoApiClient.isJsonMime = function (contentType) {
        return Boolean(contentType !== null && contentType.match(/^application\/json(;.*)?$/i));
    };
    AlfrescoApiClient.prototype.addPromiseListeners = function (promise, eventEmitter) {
        var alfrescoPromise = Object.assign(promise, {
            on: function () {
                eventEmitter.on.apply(eventEmitter, arguments);
                return this;
            },
            once: function () {
                eventEmitter.once.apply(eventEmitter, arguments);
                return this;
            },
            emit: function () {
                eventEmitter.emit.apply(eventEmitter, arguments);
                return this;
            },
            off: function () {
                eventEmitter.off.apply(eventEmitter, arguments);
                return this;
            },
        });
        return alfrescoPromise;
    };
    return AlfrescoApiClient;
}());
export { AlfrescoApiClient };
//# sourceMappingURL=../../../src/alfrescoApiClient.js.map